<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VulnScanr Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #2c3e50; }
        .controls { margin-bottom: 20px; }
        .btn { background: #2c3e50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #1a252f; }
        #file-info { margin-left: 10px; font-style: italic; color: #555; }
        .summary { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex: 1 1 160px; text-align: center; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin: 0; color: #555; font-size: 1em; }
        .card .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .card.critical { border-top: 5px solid #ff4444; }
        .card.high { border-top: 5px solid #ff8800; }
        .card.medium { border-top: 5px solid #ffcc00; }
        .card.low { border-top: 5px solid #00cc66; }
        .info-box { background: white; border-radius: 10px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .info-box h2 { margin-top: 0; color: #2c3e50; }
        .badge { background: #eee; padding: 5px 12px; border-radius: 20px; display: inline-block; margin: 3px; font-size: 0.9em; }
        .chart-container { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            text-align: center; 
            display: flex;
            justify-content: center;
        }
        .chart-container canvas { 
            max-width: 800px; 
            max-height: 400px; 
            width: 100%;
            height: auto;
        }
        .filter { margin-bottom: 15px; }
        .filter input { padding: 8px 12px; width: 250px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #2c3e50; color: white; cursor: pointer; user-select: none; }
        th:hover { background-color: #1a252f; }
        tr:hover { background-color: #f1f1f1; }
        .severity-critical { color: #ff4444; font-weight: bold; }
        .severity-high { color: #ff8800; font-weight: bold; }
        .severity-medium { color: #ffcc00; font-weight: bold; }
        .severity-low { color: #00cc66; font-weight: bold; }
        .error { color: #ff4444; padding: 20px; text-align: center; }
        /* Legend colors */
        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç VulnScanr Dashboard</h1>
        <div class="controls">
            <button class="btn" id="loadBtn">üìÇ Load JSON Report</button>
            <span id="file-info"></span>
        </div>

        <!-- Severity summary cards -->
        <div class="summary" id="summaryCards"></div>

        <!-- Detailed scan info -->
        <div class="info-box" id="scanInfoBox">
            <h2>üìã Scan Summary</h2>
            <div id="scanDetails">No report loaded.</div>
        </div>

        <!-- Chart with custom colors -->
        <div class="chart-container">
            <canvas id="typeChart"></canvas>
        </div>

        <!-- Legend matching your image -->
        <!-- <div class="legend">
            <div class="legend-item"><span class="legend-color" style="background:#ff4444;"></span> SQL Injection</div>
            <div class="legend-item"><span class="legend-color" style="background:#ff8800;"></span> XSS</div>
            <div class="legend-item"><span class="legend-color" style="background:#ffcc00;"></span> Command Injection</div>
            <div class="legend-item"><span class="legend-color" style="background:#00cc66;"></span> File Inclusion</div>
            <div class="legend-item"><span class="legend-color" style="background:#3399ff;"></span> Path Traversal</div>
            <div class="legend-item"><span class="legend-color" style="background:#9966ff;"></span> Missing Security Header</div>
            <div class="legend-item"><span class="legend-color" style="background:#ff99cc;"></span> CSRF (Missing Token)</div>
            <div class="legend-item"><span class="legend-color" style="background:#66cccc;"></span> Weak Password (Brute Force)</div>
            <div class="legend-item"><span class="legend-color" style="background:#000066;"></span> Direct Input</div>
        </div> -->

        <!-- Filter and table (Parameter column removed) -->
        <div class="filter">
            <input type="text" id="filterInput" placeholder="Filter by type, URL, payload...">
        </div>
        <table id="findingsTable">
            <thead>
                <tr>
                    <th data-col="type">Type</th>
                    <th data-col="url">URL</th>
                    <th data-col="payload">Parameter / Payload</th>
                    <th data-col="severity">Severity</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        (function() {
            // ----- State -----
            let findings = [];
            let filteredFindings = [];
            let sortColumn = 'type';
            let sortDirection = 'asc';
            let chartInstance = null;

            // ----- DOM elements -----
            const loadBtn = document.getElementById('loadBtn');
            const fileInfo = document.getElementById('file-info');
            const summaryCards = document.getElementById('summaryCards');
            const scanDetails = document.getElementById('scanDetails');
            const filterInput = document.getElementById('filterInput');
            const tableBody = document.getElementById('tableBody');

            // ----- Color mapping based on your legend -----
            const typeColors = {
                'SQL Injection': '#ff4444',
                'XSS': '#ff8800',
                'Command Injection': '#ffcc00',
                'File Inclusion': '#00cc66',
                'Path Traversal': '#3399ff',
                'Missing Security Header': '#9966ff',
                'CSRF (Missing Token)': '#ff99cc',
                'Weak Password (Brute Force)': '#66cccc',
                'Direct Input': '#000066'
            };

            // ----- Event: Load JSON -----
            loadBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    fileInfo.textContent = `Loading: ${file.name}...`;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            processData(data);
                            fileInfo.textContent = `Loaded: ${file.name}`;
                        } catch (err) {
                            alert(`Invalid JSON: ${err.message}`);
                            console.error('Parse error:', err);
                            fileInfo.textContent = 'Error loading file.';
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });

            // ----- Process the loaded data -----
            function processData(data) {
                if (data.findings && Array.isArray(data.findings)) {
                    findings = data.findings;
                } else if (Array.isArray(data)) {
                    findings = data;
                } else {
                    findings = [];
                }
                filteredFindings = [...findings];

                updateSummary(data);
                updateScanInfo(data);
                updateChart();
                renderTable();
            }

            // ----- Update severity summary cards -----
            function updateSummary(data) {
                const total = findings.length;
                let critical = 0, high = 0, medium = 0, low = 0;
                findings.forEach(f => {
                    const sev = (f.severity || '').toLowerCase();
                    if (sev.includes('critical')) critical++;
                    else if (sev.includes('high')) high++;
                    else if (sev.includes('medium')) medium++;
                    else if (sev.includes('low')) low++;
                });

                summaryCards.innerHTML = `
                    <div class="card"><h3>Total Findings</h3><div class="value">${total}</div></div>
                    <div class="card critical"><h3>Critical</h3><div class="value">${critical}</div></div>
                    <div class="card high"><h3>High</h3><div class="value">${high}</div></div>
                    <div class="card medium"><h3>Medium</h3><div class="value">${medium}</div></div>
                    <div class="card low"><h3>Low</h3><div class="value">${low}</div></div>
                `;
            }

            // ----- Update scan info box -----
            function updateScanInfo(data) {
                const scanInfo = data.scan_info || {};
                const target = scanInfo.target || 'N/A';
                const scanDate = scanInfo.scan_date || 'N/A';
                const total = scanInfo.total_findings || findings.length;

                const typeCount = {};
                findings.forEach(f => {
                    const type = f.type || 'Unknown';
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });

                let breakdownHtml = '';
                for (const [type, count] of Object.entries(typeCount)) {
                    breakdownHtml += `<span class="badge">${type}: ${count}</span>`;
                }
                if (breakdownHtml === '') breakdownHtml = '<span>No findings</span>';

                scanDetails.innerHTML = `
                    <p><strong>Target:</strong> ${target}</p>
                    <p><strong>Scan Date:</strong> ${scanDate}</p>
                    <p><strong>Total Findings:</strong> ${total}</p>
                    <div><strong>Vulnerability Breakdown:</strong><br> ${breakdownHtml}</div>
                `;
            }

            // ----- Update chart -----
            function updateChart() {
                const typeCount = {};
                findings.forEach(f => {
                    const type = f.type || 'Unknown';
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });

                const labels = Object.keys(typeCount);
                const values = Object.values(typeCount);
                const colors = labels.map(label => typeColors[label] || '#cccccc');

                const ctx = document.getElementById('typeChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Vulnerabilities by Type' }
                        }
                    }
                });
            }

            // ----- Render table (no parameter column) -----
            function renderTable() {
                tableBody.innerHTML = '';
                filteredFindings.forEach(f => {
                    const row = tableBody.insertRow();
                    const type = f.type || '';
                    const url = f.url || '';
                    const payload = f.payload || '';
                    const severity = f.severity || '';

                    row.innerHTML = `
                        <td>${escapeHtml(type)}</td>
                        <td>${escapeHtml(url)}</td>
                        <td>${escapeHtml(payload)}</td>
                        <td class="severity-${severity.toLowerCase()}">${escapeHtml(severity)}</td>
                    `;
                });
            }

            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // ----- Filtering -----
            filterInput.addEventListener('keyup', () => {
                const term = filterInput.value.toLowerCase();
                filteredFindings = findings.filter(f => 
                    (f.type || '').toLowerCase().includes(term) ||
                    (f.url || '').toLowerCase().includes(term) ||
                    (f.payload || '').toLowerCase().includes(term) ||
                    (f.severity || '').toLowerCase().includes(term)
                );
                renderTable();
            });

            // ----- Sorting -----
            document.querySelectorAll('th[data-col]').forEach(th => {
                th.addEventListener('click', () => {
                    const col = th.dataset.col;
                    if (sortColumn === col) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = col;
                        sortDirection = 'asc';
                    }
                    sortTable(col, sortDirection);
                    renderTable();
                });
            });

            function sortTable(col, dir) {
                filteredFindings.sort((a, b) => {
                    let av = a[col] || '';
                    let bv = b[col] || '';
                    if (typeof av === 'string') av = av.toLowerCase();
                    if (typeof bv === 'string') bv = bv.toLowerCase();
                    if (av < bv) return dir === 'asc' ? -1 : 1;
                    if (av > bv) return dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }
        })();
    </script>
</body>
</html>